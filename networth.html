<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Individual Net Worth Percentile Calculator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      body {
        font-family: 'Segoe UI', Roboto, sans-serif;
        background-color: #f9f9f9;
        color: #333;
        margin: 40px;
        line-height: 1.6;
      }
      h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
        color: #222;
      }
      label {
        display: block;
        margin-bottom: 10px;
        font-weight: 500;
      }
      input[type="number"],
      select,
      button {
        padding: 6px 10px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
      }
      button {
        background-color: #0078D4;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      button:hover {
        background-color: #005EA2;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 30px;
        background-color: white;
        box-shadow: 0 0 5px rgba(0,0,0,0.05);
      }
      th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: right;
        font-size: 0.95em;
      }
      th {
        background-color: #f0f0f0;
        text-align: center;
      }
      #loading {
        display: none;
        margin-top: 20px;
      }
      #loading div {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0078D4;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 10px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <h1>Individual Net Worth Percentile Calculator</h1>

    <label
      >Net Worth: $<input
        type="number"
        id="networth"
        value="1000000"
    /></label>

    <label>
      <input type="checkbox" id="includeAge" checked />
      Include Age Filter
      <select id="ageGroup">
        <option value="18-24">18–24</option>
        <option value="25-29">25–29</option>
        <option value="30-34">30–34</option>
        <option value="35-39" selected>35–39</option>
        <option value="40-44">40–44</option>
        <option value="45-49">45–49</option>
        <option value="50-54">50–54</option>
        <option value="55-59">55–59</option>
        <option value="60-64">60–64</option>
        <option value="65-120">65+</option>
      </select>
    </label>

    <label
      ><input type="checkbox" id="includeRealEstate" /> My net worth includes
      real estate</label
    >

    <label>
      <input type="checkbox" id="useEducation" />
      Include Education Level in Comparison
      <select id="education" hidden>
        <option value="1">Less than High School</option>
        <option value="2">High School Graduate</option>
        <option value="3">Some College</option>
        <option value="4">College Degree (Bachelor’s or higher)</option>
      </select>
    </label>


    <label>
      <input type="checkbox" id="individualOnly" />
      Compare to individual households only
    </label>

    <button onclick="calculateIndividualPercentile()">Calculate</button>

    <div id="loading">
      <p>Loading data, please wait...</p>
      <div></div>
    </div>

    <p id="resultMessage"></p>
    <p id="sampleStats"></p>

    <table>
      <thead>
        <tr>
          <th>Percentile</th>
          <th>Net Worth Threshold</th>
        </tr>
      </thead>
      <tbody id="percentileTable"></tbody>
    </table>

    <script>
      async function fetchSCFPIndividualData() {
        const url = 'https://raw.githubusercontent.com/LotusTwilight/SP500Simulator/main/data/SCFP2022.csv';
        const response = await fetch(url);
        const text = await response.text();
        const lines = text.split('\n');
        const header = lines[0].split(',');

        const yy1Index = header.indexOf('YY1');
        const ageIndex = header.indexOf('AGE');
        const netWorthIndex = header.indexOf('NETWORTH');
        const educIndex = header.indexOf('EDCL');
        const houseclIndex = header.indexOf('HOUSECL');
        const weightIndex = header.indexOf('WGT');
        const famstructIndex = header.indexOf('FAMSTRUCT');

        return lines.slice(1).map(line => {
          const cols = line.split(',');
          const yy1 = cols[yy1Index];
          const age = parseInt(cols[ageIndex]);
          const netWorth = parseFloat(cols[netWorthIndex]);
          const education = parseInt(cols[educIndex]);
          const housecl = parseInt(cols[houseclIndex]);
          const weight = parseFloat(cols[weightIndex]);
          const famstruct = parseInt(cols[famstructIndex]);

          return (isNaN(age) || isNaN(netWorth) || isNaN(education) || isNaN(weight) || isNaN(famstruct)) ? null : {
            yy1, age, netWorth, education, housecl, weight, famstruct
          };
        }).filter(v => v !== null);
      }

      async function calculateIndividualPercentile() {
        document.getElementById("loading").style.display = "block";

        const ageRange = document.getElementById("ageGroup").value.split("-");
        const minAge = parseInt(ageRange[0]);
        const maxAge = parseInt(ageRange[1]);
        const userNetWorth = parseFloat(document.getElementById("networth").value);
        const userEducation = parseInt(document.getElementById("education").value);
        const useEducation = document.getElementById("useEducation").checked;
        const includeRealEstate = document.getElementById("includeRealEstate").checked;
        const individualOnly = document.getElementById("individualOnly").checked;
        const includeAge = document.getElementById("includeAge").checked;


        const data = await fetchSCFPIndividualData();
        document.getElementById("loading").style.display = "none";

        const groupedByPEU = new Map();
        for (const d of data) {
          if (!groupedByPEU.has(d.yy1)) {
            groupedByPEU.set(d.yy1, {
              yy1: d.yy1,
              age: d.age,
              education: d.education,
              housecl: d.housecl,
              famstruct: d.famstruct,
              netWorthSum: 0,
              weightSum: 0,
              count: 0
            });
          }
          const g = groupedByPEU.get(d.yy1);
          g.netWorthSum += d.netWorth;
          g.weightSum += d.weight;
          g.count += 1;
        }

        const averagedPEUs = Array.from(groupedByPEU.values()).map(g => ({
          yy1: g.yy1,
          age: g.age,
          education: g.education,
          housecl: g.housecl,
          famstruct: g.famstruct,
          netWorth: g.netWorthSum / g.count,
          weight: g.weightSum / g.count
        }));

        const sortedPEUsDesc = averagedPEUs.sort((a, b) => b.netWorth - a.netWorth);
        const top7PEUIds = new Set(sortedPEUsDesc.slice(0, 7).map(d => d.yy1));
        const trimmedAll = averagedPEUs.filter(d => !top7PEUIds.has(d.yy1));

        const filtered = trimmedAll.filter(d =>
          (!includeAge || (d.age >= minAge && d.age <= maxAge)) &&
          (useEducation ? d.education === userEducation : true) &&
          (includeRealEstate ? true : d.housecl === 2) &&
          (individualOnly ? d.famstruct === 1 : true)
        );

        const sorted = filtered.sort((a, b) => a.netWorth - b.netWorth);
        const totalWeight = sorted.reduce((sum, d) => sum + d.weight, 0);
        const sampleSize = sorted.length;


        let cumulativeWeight = 0;
        const percentiles = {};
        const targets = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90, 95, 99];

        for (const p of targets) {
          const targetWeight = (p / 100) * totalWeight;
          cumulativeWeight = 0;
          for (let i = 0; i < sorted.length; i++) {
            cumulativeWeight += sorted[i].weight;
            if (cumulativeWeight >= targetWeight) {
              percentiles[p] = sorted[i].netWorth;
              break;
            }
          }
        }

        cumulativeWeight = 0;
        for (let i = 0; i < sorted.length; i++) {
          if (sorted[i].netWorth < userNetWorth) {
            cumulativeWeight += sorted[i].weight;
          }
        }
          const userPercentile = ((cumulativeWeight / totalWeight) * 100).toFixed(1);

          const ageText = includeAge ? ` aged ${minAge}–${maxAge}` : '';
          document.getElementById("resultMessage").innerText =
            `You are in the ${userPercentile}th percentile for net worth among U.S. households${ageText}${useEducation ? ' with education level ' + document.getElementById("education").selectedOptions[0].text : ''}${includeRealEstate ? '' : ' (excluding real estate)'}${individualOnly ? ', comparing to individual households only' : ''}.`;
          document.getElementById("sampleStats").innerText = `Sample size: ${sampleSize} PEUs,      representing approximately ${Math.round(totalWeight).toLocaleString()} U.S. households.`;


          const tableBody = document.getElementById("percentileTable");
          tableBody.innerHTML = "";
          for (const p of Object.keys(percentiles)) {
            const row = document.createElement("tr");
            const cell1 = document.createElement("td");
            const cell2 = document.createElement("td");
            cell1.textContent = `${p}th`;
            cell2.textContent = `$${Math.round(percentiles[p]).toLocaleString()}`;
            row.appendChild(cell1);
            row.appendChild(cell2);
            tableBody.appendChild(row);
          }
        }

        document.getElementById("includeAge").addEventListener("change", function () {
          document.getElementById("ageGroup").hidden = !this.checked;
        });

        document.getElementById("useEducation").addEventListener("change", function () {
          document.getElementById("education").hidden = !this.checked;
        });

    </script>
  </body>
</html>
